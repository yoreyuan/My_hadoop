升级CDH
---
[Upgrading CDH](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cdh_upgrading_top.html)

查看当前CDH版本支持升级的版本信息：[Supported Upgrade Paths](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_upgrade_paths.html#ug_upgrade_paths)

例如 5.16 的版本，可以升级到最高版本是 6.2.x 

# 一、收集信息
登陆 Manager Server host

执行如下命令
```
[root@cdh1 ~]# lsb_release -a
LSB Version:    :core-4.1-amd64:core-4.1-noarch
Distributor ID: CentOS
Description:    CentOS Linux release 7.4.1708 (Core)
Release:        7.4.1708
Codename:       Core
```

登陆Cloudera Manager管理控制台：
* 群集中使用的Cloudera Manager版本。转到支持 > 关于。
* 集群中部署的JDK版本。转到支持 > 关于。
* CDH是否启用了高可用。转到HDFS服务，点击`操作`按钮，如果看到`禁用高可用性`，则集群已启用高可用性。

# 二、准备升级
1. 您必须具有对Cloudera Manager服务器主机的SSH访问权限，并且能够使用root帐户或对所有主机具有无密码sudo权限的帐户登录。
2. 如果升级是需要升级操作系统，先升级操作系统
3. 确保在群集中安装了Java 1.7或1.8。Cloudera Manager 6.0.0及更高版本和CDH 6.0.0及更高版本需要Java 1.8。
4. 查看文档：[CDH 5发行说明](http://www.cloudera.com/content/cloudera/en/documentation/core/latest/topics/rg_release_notes_cdh.html)、
[Cloudera安全公告](https://www.cloudera.com/documentation/other/security-bulletins/topics/Security-Bulletin.html)
5. 查看升级过程并预留维护时段，并指定足够的时间来执行所有步骤。对于生产群集，Cloudera建议分配最多一整天的维护时段来执行升级，具体取决于主机数量，
Hadoop和Linux的使用经验以及您使用的特定硬件。
6. 如果群集使用Impala，请根据[不兼容的更改中](https://www.cloudera.com/documentation/enterprise/upgrade/topics/rg_cdh_600_incompatible_changes.html#impala_incompatible_changes_c6b1)
列出的最新保留字检查SQL 。如果要跨多个版本升级，或者遇到任何问题，请检查[Impala关键字](https://www.cloudera.com/documentation/enterprise/upgrade/topics/impala_reserved_words.html#reserved_words)的完整列表 。
7. 运行安全检查器并修复任何报告的错误。点击 `管理 > 安全性 > 安全性检查器`
8. 以`hdfs`用户登录任何集群节点，运行以下命令，并更正任何报告的错误：`$ hdfs fsck / -includeSnapshots` 、`$ hdfs dfsadmin -report`
9. 在任意 DataNode 节点以`hdfs`用户登录，行以下命令，并更正任何报告的错误：`$ hbase hbck`
10. 如果群集使用Kudu，请登录到群集任何主机以`kudu` 用户（sudo -u kudu）并运行 `ksck` 命令 。  `kudu cluster ksck master_ip:7051`
11. 如果您的群集使用Sentry和Oracle数据库，并且您要从CDH 5.13.0或更高版本升级到CDH 5.16.0或更高版本，
则必须手动添加`AUTHZ_PATH.AUTHZ_OBJ_ID`索引（如果该索引尚不存在）。手动添加索引会减少Sentry为获取HDFS同步的完整快照所需的时间。
使用以下命令添加索引：`CREATE INDEX "AUTHZ_PATH_FK_IDX" ON "AUTHZ_PATH" ("AUTHZ_OBJ_ID");`
12. 打开Cloudera Manager管理控制台并收集有关您的环境的以下信息，
13. 在开始升级之前备份Cloudera Manager。请参阅[备份Cloudera Manager](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_backup.html#ug_cm_upgrade_backup)。


# 三、备份Cloudera Manager
Cloudera建议您在升级之前执行这些备份步骤。备份将允许您根据需要回滚Cloudera Manager升级。

## Step 1: 收集备份Cloudera Manager的信息
1. 登录Cloudera Manager Server主机
2. 通过运行以下命令收集数据库信息：
```
[root@cdh1 ~]# cat /etc/cloudera-scm-server/db.properties
# Auto-generated by scm_prepare_database.sh on Thu Apr 25 09:47:50 CST 2019
#
# For information describing how to configure the Cloudera Manager Server
# to connect to databases, see the "Cloudera Manager Installation Guide."
#
com.cloudera.cmf.db.type=mysql
com.cloudera.cmf.db.host=localhost
com.cloudera.cmf.db.name=scm
com.cloudera.cmf.db.user=scm
com.cloudera.cmf.db.setupType=EXTERNAL
com.cloudera.cmf.db.password=scm
```
3. 收集以下数据库的信息（主机名，端口号，数据库名，用户名和密码）
* Reports Manager
* Navigator Audit Server
* Navigator Metadata Server
* Activity Monitor  
群集 > Cloudera管理服务 > 配置，然后在左侧类别中分别选择上面几个对应的服务，查看数据库信息。您可能需要与数据库管理员联系以获取密码。
4. 找到运行Service Monitor，Host Monitor和Event Server角色的主机。转到`群集 > Cloudera Management Service > 实例`并记下哪些主机正在运行这些角色。
5. 确定Cloudera Navigator Metadata Server存储目录的位置：
```
转到群集 > Cloudera Management Service > 实例。
单击“ 配置”选项卡。
选择 Scope > Navigator Metadata Server。
该 Navigator Metadata Server Storage Dir 属性存储目录的位置。`nav.data.dir : /var/lib/cloudera-scm-navigator`
```
6. 确保Navigator Metadata Server Java堆足够大以完成升级。 
```
集群 > Cloudera Management Service > 实例.
在实例列表中，单击 Navigator Metadata Server.
选择日志文件 > 角色日志文件。
搜索日志文件 solr core nav_elements 并注意元素文档的数量。
搜索日志文件 solr core nav_relations 并注意关系文件的数量。
将每个文档的文档总数乘以200个字节，并为其添加2 GB的基线：
`((num_nav_elements + num_nav_relations) * 200 bytes) + 2 GB`
    例如，如果您有68813088个元素和78813930关系，建议的Java堆大小约为30 GB：
    `((68813088 + 78813930) * 200) + 2 GB = 29525403600 bytes = ~29.5 GB + 2 GB = ~ 31.5 GB`
在Clusters > Cloudera Management Service > Configuration中以字节为单位在Navigator Metadata Server的Java堆大小中设置堆值。
```

## Step 2: 备份Cloudera Manager Agent
在所有主机上备份以下Cloudera Manager Agent 文件：
* 创建顶级备份目录。
```bash
export CM_BACKUP_DIR="`date +%F`-CM"
echo $CM_BACKUP_DIR
mkdir -p $CM_BACKUP_DIR
```

* 备份代理目录和运行时状态。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-agent.tar --exclude=*.sock /etc/cloudera-scm-agent /etc/default/cloudera-scm-agent /var/run/cloudera-scm-agent /var/lib/cloudera-scm-agent
```

* 备份现有的存储库目录。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/repository.tar /etc/yum.repos.d
```

## Step 3: 备份 Cloudera Management Service
* 在配置Service Monitor角色的主机上，备份以下目录：
```bash
sudo cp -rp /var/lib/cloudera-service-monitor /var/lib/cloudera-service-monitor-`date +%F`-CM
```

* 在Host Monitor角色配置为运行的主机上，备份以下目录：
```bash
sudo cp -rp /var/lib/cloudera-host-monitor /var/lib/cloudera-host-monitor-`date +%F`-CM
```

* 在将Event Server角色配置为运行的主机上，备份以下目录：
```bash
sudo cp -rp /var/lib/cloudera-scm-eventserver /var/lib/cloudera-scm-eventserver-`date +%F`-CM
```

## Step 4: 备份Cloudera Navigator数据

* 确保最近运行清除任务以清除过时和已删除的实体。
    + 您可以在Cloudera Navigator控制台中查看上次清除任务的时间（从Cloudera Manager管理控制台，转到 集群 > Cloudera Navigator，选择Administration > Purge Settings。）
    + 如果最近未运行清除，请通过编辑同一页面上的清除计划来运行清除。
    + 设置清除过程选项以清除尽可能多的积压数据，因为您可以容忍升级后的系统。请参阅使用清除管理元数据存储。

* 停止Navigator Metadata Server。

* 备份Cloudera Navigator Solr存储目录。
```bash
sudo cp -rp /var/lib/cloudera-scm-navigator /var/lib/cloudera-scm-navigator-`date +%F`-CM
```

## Step 5: 停止Cloudera Manager Server和Cloudera Management Service
* 停止 `Cloudera Management Service`

* 登录Cloudera Manager Server主机

* 停止Cloudera Manager Server。
```bash
sudo systemctl stop cloudera-scm-server
```

## Step 6: 备份Cloudera Manager数据库
备份 `Cloudera Manager server database` - 运行以下命令。
（下面显示的命令取决于您在本页顶部的表单中选择的数据库。将占位符替换为从db.properties 文件）：
```bash
mysqldump --databases database_name --host=database_hostname --port=database_port -u user_name -p > $HOME/database_name-backup-`date +%F`-CM.sql
```

备份**All other Cloudera Manager databases** - 使用您在上一步中收集的数据库信息。
    + Reports Manager
    + Navigator Audit Server
    + Navigator Metadata Server
    + Activity Monitor (Only used for MapReduce 1 monitoring).
运行以下命令以备份数据库。（下面显示的命令取决于您在本页顶部的表单中选择的数据库。将占位符替换为实际值。）：
```bash
mysqldump --databases database_name --host=database_hostname --port=database_port -u database_username -p > $HOME/database_name-backup-`date +%F`-CM.sql
```

## Step 7: 备份Cloudera Manager Server
* 登录Cloudera Manager Server主机。

* 创建顶级备份目录。
```bash
export CM_BACKUP_DIR="`date +%F`-CM"
echo $CM_BACKUP_DIR
mkdir -p $CM_BACKUP_DIR
```

* 备份Cloudera Manager Server目录：
```bash
sudo -E tar -cf $CM_BACKUP_DIR/cloudera-scm-server.tar /etc/cloudera-scm-server /etc/default/cloudera-scm-server
```

* 备份现有的存储库目录。
```bash
sudo -E tar -cf $CM_BACKUP_DIR/repository.tar /etc/yum.repos.d
```

## Step 8: （可选）启动Cloudera Manager Server和Cloudera Management Service
启动Cloudera Manager服务器和Cloudera Manager Management服务。

如果要立即升级Cloudera Manager，请跳过此步骤并继续[升级Cloudera Manager Server](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cm_upgrade_server.html#ug_cm_upgrade_server)。

1. 登录Cloudera Manager Server主机。 
2. 启动Cloudera Manager Server。   `sudo systemctl start cloudera-scm-server`
3. 启动 Cloudera Management Service。  



# 四、升级 Cloudera Manager Server

## Step 1: 建立对软件的访问权限
* 登录Cloudera Manager Server主机

* 删除现有存储库目录中的所有旧文件：
```bash
sudo rm /etc/yum.repos.d/cloudera*manager.repo*
```

* 创建存储库文件，以便包管理器可以找到并下载二进制文件：
创建一个名为的文件 `/etc/yum.repos.d/cloudera-manager.repo` 具有以下内容：
```bash
[cloudera-manager]
# Packages for Cloudera Manager
name=Cloudera Manager
baseurl=https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/
gpgkey=https://archive.cloudera.com/cm6/6.2.0/redhat7/yum/RPM-GPG-KEY-cloudera
gpgcheck=1
```

* Cloudera Manager升级可以引入新的包依赖关系。您的组织可能有限制或需要事先批准安装新软件包。您可以确定可以安装或升级的软件包：
```bash
yum deplist cloudera-manager-agent
```

## Step 2: 装JDK 8
在Cloudera Manager 6.0.0或更高版本管理的所有群集主机上都需要Oracle JDK 1.8。如果主机上已安装JDK 1.8，请跳过本节中的步骤。

编辑 `/etc/default/cloudera-scm-server` 文件，添加 JDK 路径，保存
```bash
export JAVA_HOME="/usr/java/jdk1.8.0_141-cloudera"
```

## Step 3: 升级Cloudera Manager Server
* 登录Cloudera Manager Server主机

* 停止 Cloudera Management Service。 

* 确保已禁用任何计划的复制或快照作业，并等待Cloudera Manager Admin Console中的任何正在运行的命令完成，然后再继续升级。

* 停止Cloudera Manager Server。
```bash
sudo systemctl stop cloudera-scm-server
```

* 停止Cloudera Manager Agent。
```bash
sudo systemctl stop cloudera-scm-agent
```

* 升级包
```bash
sudo yum clean all
sudo yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent 
```
系统可能会提示您有关配置文件的版本：
```
Configuration file '/etc/cloudera-scm-agent/config.ini'
==> Modified (by you or by a script) since installation.
==> Package distributor has shipped an updated version.
What would you like to do about it ? Your options are:
Y or I : install the package maintainer's version
N or O : keep your currently-installed version
D : show the differences between the versions
Z : start a shell to examine the situation
The default action is to keep your current version.
```

您可能会收到类似的提示 `/etc/cloudera-scm-server/db.properties`。对两个提示回答N.
系统可能会提示您接受GPG密钥。答ÿ。
```
Retrieving key from https://archive.cloudera.com/.../cm/RPM-GPG-KEY-cloudera
Importing GPG key ...
 Userid     : "Yum Maintainer <webmaster@cloudera.com>"
 Fingerprint: ...
 From       : https://archive.cloudera.com/.../RPM-GPG-KEY-cloudera
 ```

* 如果你定制了 `/etc/cloudera-scm-agent/config.ini` 文件，您的自定义文件使用扩展名重命名 而`.rpmsave` 或者 `.dpkg-old`。
将任何自定义项合并到 `/etc/cloudera-scm-agent/config.ini` 包管理器安装的文件。

* 验证您是否安装了正确的软件包。
```bash
rpm -qa 'cloudera-manager-*'
```
如果有不需要的rpm服务，这里可以将其移除
```bash
rpm -e 上面命令的名字 --nodeps
```

* 启动Cloudera Manager Agent。
```bash
sudo systemctl start cloudera-scm-agent
```

* 启动Cloudera Manager Server。
```bash
sudo systemctl start cloudera-scm-server
```

* 使用Web浏览器使用以下URL打开Cloudera Manager Admin Console：
```bash
http://cloudera_Manager_server_hostname:7180/cmf/upgrade
http://cloudera_Manager_server_hostname:7180/cmf/upgrade-wizard/welcome
```
如果在启动服务器或代理时遇到问题（例如数据库权限问题），则可以使用日志文件来解决问题：
```bash
tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log
tail -f /var/log/cloudera-scm-agent/cloudera-scm-agent.log
tail -f /var/log/messages
```


# 五、升级 Cloudera Manager Agents
您可以使用以下两个选项之一升级代理。

## 选项1：使用Cloudera Manager升级代理（推荐）
**注意**：如果Cloudera Manager在此过程中显示与以下内容类似的错误消息，则可能是旧版本的JDK干扰了升级：
```bash
ls: cannot access '/etc/zypp/repos.d/cloudera-manager.repo.*': No such file or directory 
repository file /etc/zypp/repos.d/cloudera-manager.repo removed
```
在升级之前删除旧的JDK将允许Cloudera Manager完成升级。

Cloudera Manager Server启动并登录Cloudera Manager Admin Console后，将显示Upgrade Cloudera Manager页面。（服务器可能需要几分钟才能启动。）

如果在升级Cloudera Manager Server主机上的软件包后未显示Upgrade Cloudera Manager页面，请在Web浏览器中打开以下URL：
```bash
https://my_cloudera_manager_server_host:port/cmf/upgrade
https://my_cloudera_manager_server_host:port/cmf/upgrade-wizard/welcome
```

按照升级页面上的说明升级所有代理。


## 选项2：使用命令行升级代理
如果要从Cloudera Manager 5.5.0或更低版本升级到Cloudera Manager 5.5.0或更高版本，请在所有主机上重新启动代理以更新并重新启动 supervisord 处理。
```bash
sudo sudo systemctl stop supervisord
sudo systemctl start cloudera-scm-agent
```


# 六、升级Cloudera Manager后
## 升级Cloudera Navigator加密组件
升级群集中部署的任何Cloudera Navigator加密组件：
* Cloudera Navigator Key Trustee Server
* Cloudera Navigator Key HSM
* Cloudera Navigator Key Trustee KMS
* Cloudera Navigator Encrypt.

如果您仍在使用Key Trustee Server 5.4，并且要升级到Cloudera Manager 5.10或更高版本，则必须将Key Trustee Server升级到更新版本。

您可以随时升级其他Cloudera Navigator组件。升级Cloudera Manager或CDH时，您不必执行这些升级。

请参阅[升级Cloudera Navigator数据加密](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cn_upgrade.html#cn_upgrade)。

## 执行升级后步骤

* 如果升级了JDK，重新配置JDK。打开Cloudera Manager Admin Console并在主机配置中设置Java Home Directory属性：

* 启动Cloudera Management Service并在出现提示时调整任何配置。


# 七、故障排除


- - - - - - 

升级CDH
---
[Upgrading CDH](https://www.cloudera.com/documentation/enterprise/upgrade/topics/ug_cdh_upgrading_top.html)

以下CDH 组建不需要备份
* MapReduce
* YARN
* Spark
* Pig
* Impala

升级CDH之前，请完成以下备份步骤：
* Back Up Databases
* Back Up ZooKeeper
* Back Up HDFS
* Back Up Key Trustee Server and Clients
* Back Up HSM KMS
* Back Up Navigator Encrypt
* Back Up HBase
* Back Up Sqoop 2
* Back Up Hue

## Step2: 备份 Zookeeper
在所有ZooKeeper主机上，备份使用指定的ZooKeeper数据目录 `dataDir` ZooKeeper配置中的属性。默认位置是 在`/var/lib/zookeeper`。例如：
```bash
cp -rp /var/lib/zookeeper/ /var/lib/zookeeper-backup-`date +%F`CM5.16-CDH5.16
```
要识别ZooKeeper主机，请打开Cloudera Manager管理控制台并转到ZooKeeper服务，然后单击Instances选项卡。

记录文件和目录的权限; 你将需要这些来回滚ZooKeeper。


## 下载
点击 Hosts > Parcels > 配置  
在`远程 Parcel 存储库 URL`中添加如下链接
```bash
https://archive.cloudera.com/cdh6/6.2.0/parcels/
```

其他资源链接
```bash
# 访问 https://www.cloudera.com/documentation/spark2/latest/topics/spark2_packaging.html#versions
http://archive.cloudera.com/spark2/parcels/2.4.0.cloudera2/
```

